<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="icu.chenz.commentx.dao.CommentDao">
    <resultMap id="comment" type="commentEntity">
        <association property="subComments" column="id"
                     select="icu.chenz.commentx.dao.CommentDao.getSubCommentsByParentId"/>
    </resultMap>
    <insert id="create" parameterType="commentEntity" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
        insert into comments(context, content, reply, parent, user, ctime)
            value (#{context}, #{content}, #{reply}, #{parent}, #{user},
                   round(unix_timestamp(current_timestamp(3)) * 1000, 0))
    </insert>
    <update id="delete">
        update comments
        set visible=0,
            mtime=round(unix_timestamp(current_timestamp(3)) * 1000, 0)
        where id = #{id}
    </update>
    <select id="getByContext" resultType="commentEntity" resultMap="comment">
        select id,
               context,
               content,
               reply,
               parent,
               user,
               ctime,
               mtime
        from comments
        where context = #{context}
          and visible = 1
          and parent is null
        order by ctime
    </select>
    <select id="getSubCommentsByParentId" resultType="commentEntity">
        select id,
               context,
               content,
               reply,
               parent,
               user,
               ctime,
               mtime
        from comments
        where parent = #{parent}
          and visible = 1
        order by ctime
    </select>
    <select id="getContextString" resultType="string">
        select name
        from contexts
        where name = #{name}
    </select>
</mapper>